<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> C#多线程与异步操作 · MJ's Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="C#多线程与异步操作 - MJ"><meta name="keywords"><meta name="author" content="MJ"><link rel="short icon" href="/images/assassins_creed.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://weimingjuncn.github.io/atom.xml" title="MJ's Blog"><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script><meta name="generator" content="Hexo 4.2.0"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/assassins_creed_white.png"></a><ul id="nav_list" class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div><div id="nav_btn" class="nav-btn"><span></span><span></span><span></span></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">C#多线程与异步操作</h1><div class="post-info">2020-03-31</div><div class="post-content"><p>什么是线程？为什么使用线程？线程的使用、线程池、任务、委托异步执行、Thread类、Task类</p>
<a id="more"></a>

<h1 id="一、线程基础"><a href="#一、线程基础" class="headerlink" title="一、线程基础"></a>一、线程基础</h1><h2 id="为什么使用线程？"><a href="#为什么使用线程？" class="headerlink" title="为什么使用线程？"></a>为什么使用线程？</h2><ol>
<li>将某段代码同其他低吗隔离，提高应用程序可靠性。</li>
<li>简化代码。</li>
<li>实现并发执行</li>
</ol>
<p><strong>什么是并发执行？</strong></p>
<p>…</p>
<h2 id="什么是线程？"><a href="#什么是线程？" class="headerlink" title="什么是线程？"></a>什么是线程？</h2><h3 id="1-进程与线程"><a href="#1-进程与线程" class="headerlink" title="1. 进程与线程"></a>1. 进程与线程</h3><p><strong>进程</strong>是<strong>操作系统执行程序的基本单位</strong>，<strong>拥有应用程序的资源</strong>。</p>
<p>进程包含线程，<strong>进程的资源被线程共享</strong>，<strong>线程不拥有资源</strong>。</p>
<h3 id="2-前台线程和后台线程"><a href="#2-前台线程和后台线程" class="headerlink" title="2. 前台线程和后台线程"></a>2. 前台线程和后台线程</h3><p>通过<strong>Thread类新建线程</strong>默认为<strong>前台线程</strong>。<strong>当所有前台线程关闭时，所有的后台线程也会被直接终止，不会抛出异常</strong>。</p>
<h3 id="3-挂起（Suspend）和唤醒（Resume）"><a href="#3-挂起（Suspend）和唤醒（Resume）" class="headerlink" title="3. 挂起（Suspend）和唤醒（Resume）"></a>3. 挂起（Suspend）和唤醒（Resume）</h3><p>由于线程的执行顺序和程序的执行情况不可预知所以使用挂起和唤醒容易发生死锁的情况，在实际应用中应该尽量少用。</p>
<h3 id="4-阻塞线程"><a href="#4-阻塞线程" class="headerlink" title="4. 阻塞线程"></a>4. 阻塞线程</h3><h3 id="5-终止线程"><a href="#5-终止线程" class="headerlink" title="5. 终止线程"></a>5. 终止线程</h3><h3 id="6-线程优先级"><a href="#6-线程优先级" class="headerlink" title="6. 线程优先级"></a>6. 线程优先级</h3><h2 id="线程的使用"><a href="#线程的使用" class="headerlink" title="线程的使用"></a>线程的使用</h2><h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><h2 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h2><h2 id="委托异步执行"><a href="#委托异步执行" class="headerlink" title="委托异步执行"></a>委托异步执行</h2><h1 id="二、线程同步"><a href="#二、线程同步" class="headerlink" title="二、线程同步"></a>二、线程同步</h1><h2 id="原子操作（Interlocked）"><a href="#原子操作（Interlocked）" class="headerlink" title="原子操作（Interlocked）"></a>原子操作（Interlocked）</h2><h2 id="lock-语句"><a href="#lock-语句" class="headerlink" title="lock()语句"></a>lock()语句</h2><h2 id="Monitor实现线程同步"><a href="#Monitor实现线程同步" class="headerlink" title="Monitor实现线程同步"></a>Monitor实现线程同步</h2><h2 id="ReaderWriterLock"><a href="#ReaderWriterLock" class="headerlink" title="ReaderWriterLock"></a>ReaderWriterLock</h2><h2 id="事件（Event）类实现同步"><a href="#事件（Event）类实现同步" class="headerlink" title="事件（Event）类实现同步"></a>事件（Event）类实现同步</h2><h2 id="信号量（Semaphore）"><a href="#信号量（Semaphore）" class="headerlink" title="信号量（Semaphore）"></a>信号量（Semaphore）</h2><h2 id="互斥体（Mutex）"><a href="#互斥体（Mutex）" class="headerlink" title="互斥体（Mutex）"></a>互斥体（Mutex）</h2><h2 id="跨进程间的同步"><a href="#跨进程间的同步" class="headerlink" title="跨进程间的同步"></a>跨进程间的同步</h2><p>多线程处理的作用：</p>
<ol>
<li><p>实现多任务。</p>
</li>
<li><p>解决延迟。</p>
</li>
<li><p>多线程应用：计算量大的场景、计算时长久的业务，比如LOL中的战争迷雾，它需要算很多可视化和迷雾单位，需要独立的线程进行计算。</p>
</li>
<li><p>在LOL中，每个正在战斗的房间，底层也是要求相互独立，可并行的，所以也需要多线程的支持。</p>
</li>
<li><p>每次打开王者荣耀，要更新很多内容，如果不使用多线程下载更新，速度会更慢。</p>
</li>
<li><p>其他</p>
</li>
</ol>
<p>有关线程的对象：<strong>Thread</strong>（.net 4.0）、<strong>Task</strong> （.net 4.0之后）</p>
<p>线程同步保证数据的可靠性</p>
<h1 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h1><ul>
<li>创建线程<ul>
<li>构建<strong>Thread</strong>实例，参数需要指定一个方法</li>
<li>通过<strong>Start方法</strong>开始执行线程</li>
<li>如果需要给方法传递参数，则使用<strong>匿名函数( ) =&gt; { }</strong></li>
<li>如果有返回值怎么办？定义变量进行接收</li>
</ul>
</li>
<li>暂停线程<ul>
<li>通过Thread实例调用Join，可以阻止其他线程的调用，直到由该实例表示的线程终止</li>
<li><strong>线程实例.Join();</strong></li>
<li>可以传递一个参数，表示最长<strong>阻塞</strong>多长时间的（单位：毫秒）</li>
</ul>
</li>
<li>计时等待<ul>
<li><strong>Thread.Sleep()</strong>让线程休眠一段时间</li>
<li>通过<strong>静态方法</strong>可以让当前的线程等待一定的时间，由参数决定等待的时间（单位：毫秒）</li>
<li>它只影响当前执行的线程，其他线程依旧会执行</li>
</ul>
</li>
<li>终止线程<ul>
<li><strong>Thread.Abort();</strong></li>
<li>该方法终止方式是对线程进行销毁，它适用于当线程要关闭的时候进行调度，能够保证线程程序关闭，线程也被销毁</li>
<li>其他地方尽可能不要用，有其他方式，比如用在线程内部用了lock语句，那么强制关闭线程回导致lock失效从而可能影响计算结果</li>
</ul>
</li>
<li>通过<strong>信号控制</strong>线程的<strong>暂停</strong>执行和<strong>继续</strong>执行<ul>
<li><strong>ManualResetEvent</strong></li>
</ul>
</li>
<li>检测线程状态<ul>
<li><strong>thread.ThreadState</strong></li>
</ul>
</li>
<li>前台线程和后台线程<ul>
<li>后台线程程序停止后可能还会继续执行</li>
<li>前台线程程序停止都会停止掉左右前台线程，线程默认都是前台线程</li>
</ul>
</li>
<li>访问当前线程<ul>
<li><strong>Thread.CurrentThread.ManagedThreadId</strong></li>
</ul>
</li>
</ul>
<h2 id="例1"><a href="#例1" class="headerlink" title="例1"></a>例1</h2><p>本例包含：线程的<strong>创建、启动、阻塞（等待）、休眠、终止</strong></p>
<p>IDE：<strong>VS 2017</strong></p>
<p>创建项目类型：<strong>控制台应用(.NET Framework)</strong></p>
<p>项目名：<strong>Project_Thread</strong></p>
<p><strong>Program.cs</strong>代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Project_Thread</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            ThreadDemo threadDemo = <span class="keyword">new</span> ThreadDemo();<span class="comment">//实例化ThreadDemo</span></span><br><span class="line">            threadDemo.Start();<span class="comment">//启动三个任务：Thread01,Thread02,Thread03</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在项目中新建一个类，取名为<strong>ThreadDemo</strong></p>
<p><strong>ThreadDemo.cs</strong>代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Project_Thread</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">ThreadDemo</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//多个线程，可以同时执行不同的任务，减少</span></span><br><span class="line">            <span class="comment">//通过线程调用方法</span></span><br><span class="line">            Thread t1 = <span class="keyword">new</span> Thread(Thread01);</span><br><span class="line">            t1.Start();</span><br><span class="line"></span><br><span class="line">            Thread t2 = <span class="keyword">new</span> Thread(Thread02);</span><br><span class="line">            t2.Start();</span><br><span class="line"></span><br><span class="line">            Thread t3 = <span class="keyword">new</span> Thread(Thread03);</span><br><span class="line">            t3.Start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;<span class="comment">//局部变量</span></span><br><span class="line">            Thread t4 = <span class="keyword">new</span> Thread(()=&gt; &#123; count=Thread04(<span class="number">500</span>); &#125;);<span class="comment">//用匿名方法传递参数</span></span><br><span class="line">            t4.Start();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//等待线程执行完毕</span></span><br><span class="line">            t4.Join();</span><br><span class="line">            <span class="comment">/*************以下代码块是有关进程的终止**********/</span></span><br><span class="line">            Console.WriteLine(t4.ThreadState);<span class="comment">//访问进程t4的当前状态</span></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                t4.Abort();<span class="comment">//终止线程，通过抛异常的形式销毁线程</span></span><br><span class="line">                Console.WriteLine(t4.ThreadState);<span class="comment">//访问进程t4的当前状态</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)<span class="comment">//捕获异常</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(e);<span class="comment">//打印异常信息</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/********************************************/</span></span><br><span class="line">            </span><br><span class="line">            Console.WriteLine(<span class="string">"count是多少："</span> + count);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Thread01</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//Thread.Sleep(1000); //当前进程休眠1000ms（1s）</span></span><br><span class="line">                Console.WriteLine(<span class="string">"Thread01: "</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Thread02</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">"Thread02: "</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Thread03</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">"Thread03: "</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Thread04</span>(<span class="params"><span class="keyword">int</span> count</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> _count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _count++;</span><br><span class="line">                Console.WriteLine(<span class="string">"Thread04: "</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> _count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="例2"><a href="#例2" class="headerlink" title="例2"></a>例2</h2><p>本例包含<strong>暂停执行、继续执行</strong></p>
<p>给项目新建一个类，取名为ManualResetEventDemo</p>
<p>ManualResetEventDemo.cs内容如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Project_Thread</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//通过信号的形式控制线程的暂停与继续</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title">ManualResetEventDemo</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//停止信号</span></span><br><span class="line">        ManualResetEvent mr = <span class="keyword">new</span> ManualResetEvent(<span class="literal">true</span>);</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ManualResetEventDemo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Thread t = <span class="keyword">new</span> Thread(Thread01);</span><br><span class="line">            t.IsBackground = <span class="literal">false</span>;<span class="comment">//false前台线程， true后台线程</span></span><br><span class="line">            <span class="comment">//基本不会用到这个属性 软件开发可能用到比较多</span></span><br><span class="line">            <span class="comment">//前台线程会在应用程序关闭的时候全部停止掉，后台线程在程序执行完之前不会停止。</span></span><br><span class="line">            t.Start();</span><br><span class="line"></span><br><span class="line">            Start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//发送一个让线程继续执行的信号</span></span><br><span class="line">            mr.Set();<span class="comment">//继续</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Stop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            mr.Reset();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Thread01</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Thread.Sleep(<span class="number">3000</span>);</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mr.WaitOne();</span><br><span class="line">                <span class="comment">//线程ID是系统自动分配的；每次都是不同的ID, 每个线程的ID唯一。</span></span><br><span class="line">                Console.WriteLine(<span class="string">"线程的ID: "</span> + Thread.CurrentThread.ManagedThreadId);</span><br><span class="line">                i++;</span><br><span class="line">                Console.WriteLine(<span class="string">"i的值："</span> + i);</span><br><span class="line">                Thread.Sleep(<span class="number">3000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改Program.cs如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Project_Thread</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//ThreadDemo threadDemo = new ThreadDemo();//实例化ThreadDemo</span></span><br><span class="line">            <span class="comment">//threadDemo.Start();//启动三个任务：Thread01,Thread02,Thread03</span></span><br><span class="line">            ManualResetEventDemo mre = <span class="keyword">new</span> ManualResetEventDemo();</span><br><span class="line">            Console.WriteLine(<span class="string">"输入 start:继续执行线程 stop:停止线程"</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">string</span> s = Console.ReadLine();</span><br><span class="line">                <span class="keyword">if</span>(s == <span class="string">"start"</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mre.Start();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(s == <span class="string">"stop"</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mre.Stop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h1><p>.net4.0之后推出，.net4.5又开放了更多接口</p>
<ul>
<li><p>创建任务</p>
</li>
<li><p>接收返回值</p>
</li>
<li><p>计时等待</p>
</li>
<li><p>等待任务执行完毕</p>
</li>
<li><p>取消任务</p>
<p>CancellationToken</p>
<p>bool标志位 自定义逻辑 进行内部控制</p>
</li>
</ul>
<h2 id="例1（创建、接收返回值，阻塞）"><a href="#例1（创建、接收返回值，阻塞）" class="headerlink" title="例1（创建、接收返回值，阻塞）"></a>例1（创建、接收返回值，阻塞）</h2><p>通过VS 2017创建C#控制台应用项目Project_Task，新建一个类TaskDemo，编辑TaskDemo.cs如下:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Project_Task</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">TaskDemo</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//开始执行三个任务</span></span><br><span class="line">            Task.Run((Action)Task01);</span><br><span class="line">            <span class="comment">//Run有多个重载方法，因此参数前要加上(Action)，指定只需要一个Action参数的Run方法</span></span><br><span class="line">            Task.Run((Action)Task02);</span><br><span class="line">            Task.Run((Action)Task03);</span><br><span class="line"></span><br><span class="line">            Task t4 = Task.Run(() =&gt; &#123;<span class="comment">//用匿名方法传递参数</span></span><br><span class="line">               mCount = Task04(<span class="number">10</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">//线程等待，等待线程的执行完毕</span></span><br><span class="line">            t4.Wait();</span><br><span class="line">            Console.WriteLine(<span class="string">"COUNT: "</span> + mCount);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> mCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">Task04</span>(<span class="params"><span class="keyword">int</span> count</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> _count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _count++;</span><br><span class="line">                Console.WriteLine(<span class="string">"Task04: "</span> + i);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> _count;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Task03</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">"Task03: "</span> + i);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Task02</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">"Task02: "</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Task01</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">"Task01: "</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编辑Program.cs如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Project_Task</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            TaskDemo taskDemo = <span class="keyword">new</span> TaskDemo();</span><br><span class="line">            taskDemo.Start();</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();<span class="comment">//等待用户输入，阻塞程序，以便线程都工作完毕。</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序运行结果如下：</p>
<p><img src="/2020/03/31/C%20Sharp%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C/image-20200406115319542.png" alt="image-20200406115319542"></p>
<h2 id="例2（计时等待）"><a href="#例2（计时等待）" class="headerlink" title="例2（计时等待）"></a>例2（计时等待）</h2><p>修改TaskDemo.cs如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Project_Task</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">TaskDemo</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Task.Run((Action)Task05);            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">Task05</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">"Task05执行中..."</span>);</span><br><span class="line">                <span class="comment">//Task.Delay 可以执行一个延时的操作</span></span><br><span class="line">                <span class="keyword">await</span> Task.Delay(<span class="number">1000</span>);<span class="comment">//单位毫秒 1000ms = 1s</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行后控制台每隔1秒打印一次“Task05执行中…”</p>
<h2 id="例3（取消任务）"><a href="#例3（取消任务）" class="headerlink" title="例3（取消任务）"></a>例3（取消任务）</h2></div></article></div><div class="right-container"><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2020/04/01/C%20Sharp%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="C#序列化与反序列化" class="prev">上一篇</a><a href="/2020/02/24/PluralSight%E8%AF%BE%E7%A8%8B%EF%BC%9A%E6%B8%B8%E6%88%8F%E6%9C%BA%E5%88%B6%E8%AE%BE%E8%AE%A1%E5%9F%BA%E7%A1%80/" title="PluralSight课程：游戏机制设计基础" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2020 <a target="_blank">MJ</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p> <span style="padding-right: 6px;">闽ICP备16007301号-2</span></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="/scripts/ar-anchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>